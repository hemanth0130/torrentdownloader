<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>torrentDownloader</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <!-- Tailwind config + CDN -->
  <script>
    tailwind = window.tailwind || {};
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','system-ui','-apple-system','BlinkMacSystemFont','sans-serif'] },
          colors: { accent: { DEFAULT: '#38bdf8' } },
          boxShadow: { 'soft': '0 18px 45px rgba(0,0,0,0.6)' }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- WebTorrent -->
  <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

  <style>
    .line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .magnet-row { position: relative; }
    .magnet-input { padding-right: 110px; } /* space for the overlay add button */
    .magnet-add-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      min-width: 84px;
      height: 44px;
      border-radius: 12px;
      z-index: 10;
    }
    @media (min-width: 768px) {
      .magnet-input { padding-right: 150px; }
      .magnet-add-btn { min-width: 110px; height:48px; right:12px; border-radius:14px; }
    }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100 font-sans antialiased">
  <div class="max-w-3xl mx-auto p-4 pb-12">
    <!-- Header -->
    <header class="flex items-center gap-3 mb-6">
      <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-accent to-sky-500 flex items-center justify-center shadow-soft">
        <span class="text-xs font-bold uppercase">TD</span>
      </div>
      <div>
        <h1 class="text-xl font-semibold">torrent<span class="text-accent">Downloader</span></h1>
        <p class="text-xs text-slate-400">Paste magnet or upload a .torrent file — then download files or open in a native client.</p>
      </div>
    </header>

    <!-- Capability banner -->
    <div id="capBanner" class="mb-4 hidden rounded-xl p-3 text-sm"></div>

    <!-- Magnet input / Add button -->
    <section class="mb-6">
      <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
        <label class="block text-xs text-slate-400 mb-2">Paste Magnet Link or Info Hash</label>

        <div class="magnet-row mb-3">
          <input id="magnetInput" class="magnet-input w-full h-12 rounded-xl bg-slate-900 border border-slate-800 px-4 text-sm text-slate-100 placeholder:text-slate-500 focus:ring-2 focus:ring-accent/50" type="text" inputmode="url" placeholder="magnet:?xt=urn:btih:..." />
          <button id="addMagnetBtn" class="magnet-add-btn bg-accent text-slate-950 font-semibold">Add</button>
        </div>

        <div class="mt-1">
          <label class="block text-xs text-slate-400 mb-2">Or upload a .torrent file</label>
          <div class="flex gap-2 items-center">
            <input id="torrentFile" type="file" accept=".torrent" class="hidden" />
            <button id="chooseFileBtn" class="h-12 px-4 rounded-xl bg-slate-800 border border-slate-700 text-sm text-slate-200">Choose File</button>
            <div id="fileLabel" class="text-xs text-slate-400">No file chosen</div>
            <div class="ml-auto text-xs text-slate-500">Runs in your browser</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Active torrent area -->
    <section id="activeArea" class="mb-6 hidden">
      <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
        <div class="flex items-center justify-between gap-3 mb-3">
          <div class="min-w-0">
            <h2 id="torrentName" class="text-sm font-semibold text-slate-100 line-clamp-2">Adding...</h2>
            <div id="torrentStats" class="text-xs text-slate-400 mt-1">Waiting for metadata...</div>
          </div>
          <div class="text-right">
            <div id="peerCount" class="text-xs text-slate-400">Peers: 0</div>
            <button id="destroyBtn" class="mt-2 text-xs px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">Stop</button>
          </div>
        </div>

        <div class="w-full bg-slate-800 rounded-full h-3 overflow-hidden">
          <div id="progressBar" class="h-3 bg-accent w-0 transition-all"></div>
        </div>

        <div id="filesList" class="mt-4 space-y-3"></div>

        <div id="metaNotice" class="mt-3 text-xs text-slate-400 hidden"></div>

        <!-- Prominent native-app fallback -->
        <div id="nativeActionRow" class="mt-4 hidden flex flex-col gap-3">
          <div class="flex gap-3">
            <button id="openNativeBtn" class="flex-1 rounded-xl py-3 text-sm font-semibold bg-sky-600 text-slate-950">Open in native app</button>
            <button id="copyMagnetForNative" class="rounded-xl px-4 py-3 bg-slate-800 text-sm">Copy Magnet</button>
          </div>
          <div class="text-xs text-slate-500">If browser cannot connect (common on iOS), tap “Open in native app” to hand the magnet to a native torrent client.</div>
        </div>
      </div>
    </section>

  </div>

<script>
/* ============
   Config & DOM
   ============ */

const DEFAULT_WSS_TRACKERS = [
  'wss://tracker.openwebtorrent.com',
  'wss://tracker.btorrent.xyz',
  'wss://tracker.fastcast.nz',
  'wss://tracker.webtorrent.io',
  'wss://tracker.opentrackr.org',
  'wss://tracker.skyts.net',
];

const capBanner = document.getElementById('capBanner');
const magnetInput = document.getElementById('magnetInput');
const addMagnetBtn = document.getElementById('addMagnetBtn');
const chooseFileBtn = document.getElementById('chooseFileBtn');
const torrentFileInput = document.getElementById('torrentFile');
const fileLabel = document.getElementById('fileLabel');

const activeArea = document.getElementById('activeArea');
const torrentNameEl = document.getElementById('torrentName');
const torrentStatsEl = document.getElementById('torrentStats');
const peerCountEl = document.getElementById('peerCount');
const progressBar = document.getElementById('progressBar');
const filesList = document.getElementById('filesList');
const destroyBtn = document.getElementById('destroyBtn');
const metaNotice = document.getElementById('metaNotice');
const nativeActionRow = document.getElementById('nativeActionRow');
const openNativeBtn = document.getElementById('openNativeBtn');
const copyMagnetForNative = document.getElementById('copyMagnetForNative');

let client = null;
let activeTorrent = null;
let metadataTimer = null;

/* ============
   Capability check
   ============ */

function supportsWebRTC() {
  const rtc = typeof RTCPeerConnection !== 'undefined' || typeof webkitRTCPeerConnection !== 'undefined' || typeof mozRTCPeerConnection !== 'undefined';
  const ws = typeof WebSocket !== 'undefined';
  return rtc && ws;
}

function showCapabilityBanner() {
  if (!supportsWebRTC()) {
    capBanner.className = 'mb-4 rounded-xl p-3 text-sm bg-rose-900/60 text-rose-200';
    capBanner.innerHTML = '<strong>Browser not suitable for in-browser torrenting.</strong> Use "Open in native app" or try desktop Chrome/Firefox.';
    capBanner.classList.remove('hidden');
  } else {
    capBanner.className = 'mb-4 rounded-xl p-2 text-sm bg-emerald-900/10 text-emerald-300 border border-emerald-800';
    capBanner.textContent = 'Browser supports WebRTC; in-browser torrenting may work (depends on WebRTC-capable peers).';
    capBanner.classList.remove('hidden');
    setTimeout(()=> capBanner.classList.add('hidden'), 3000);
  }
}
showCapabilityBanner();

/* ============
   Helpers
   ============ */

function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function normalizeToMagnet(input) {
  if (!input) return null;
  input = input.trim();
  if (/^magnet:\?/i.test(input)) return input;
  input = input.replace(/^<|>$/g, '').replace(/^"|"$/g, '');
  const hexMatch = input.match(/^[0-9a-fA-F]{40}$/);
  const base32Match = input.match(/^[A-Z2-7]{32}$/i);
  if (hexMatch || base32Match) {
    const trackers = DEFAULT_WSS_TRACKERS.map(t => `&tr=${encodeURIComponent(t)}`).join('');
    return `magnet:?xt=urn:btih:${input}${trackers}`;
  }
  return null;
}

function copyToClipboard(text, buttonFallback) {
  if (!text) return;
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(()=> {
      if (buttonFallback) {
        const old = buttonFallback.textContent;
        buttonFallback.textContent = 'Copied';
        setTimeout(()=> buttonFallback.textContent = old, 1000);
      }
    }).catch(()=> fallbackCopy(text, buttonFallback));
  } else {
    fallbackCopy(text, buttonFallback);
  }
}
function fallbackCopy(text, btn) {
  const ta = document.createElement('textarea'); ta.value = text; ta.style.position='fixed'; ta.style.left='-9999px';
  document.body.appendChild(ta); ta.select();
  try { document.execCommand('copy'); if (btn){ const old = btn.textContent; btn.textContent='Copied'; setTimeout(()=>btn.textContent=old,1000);} } catch(e){ alert('Copy failed'); }
  document.body.removeChild(ta);
}

/* ============
   WebTorrent logic
   ============ */

function ensureClient() {
  if (!client && supportsWebRTC()) {
    try { client = new WebTorrent(); } catch(e) { console.error('WebTorrent init error', e); }
  }
}

function startAddMagnet(rawInput) {
  const magnet = normalizeToMagnet(rawInput) || rawInput;
  if (!magnet || !magnet.startsWith('magnet:?')) {
    metaNotice.classList.remove('hidden');
    metaNotice.textContent = 'Invalid magnet or info-hash. Paste a magnet:? link or upload a .torrent file.';
    return;
  }

  // always show native fallback controls so user can immediately use them
  nativeActionRow.classList.remove('hidden');
  openNativeBtn.onclick = () => { window.location.href = magnet; };
  copyMagnetForNative.onclick = () => copyToClipboard(magnet, copyMagnetForNative);

  if (!supportsWebRTC()) {
    activeArea.classList.remove('hidden');
    torrentNameEl.textContent = 'Browser not suitable for in-browser torrenting';
    torrentStatsEl.textContent = 'Use "Open in native app" or upload a .torrent file.';
    metaNotice.classList.remove('hidden');
    metaNotice.textContent = 'Your browser lacks required WebRTC features. Try desktop Chrome/Firefox or open the magnet in a native app.';
    return;
  }

  addTorrent(magnet);
}

function addTorrent(magnetOrBuffer) {
  ensureClient();
  if (!client) {
    metaNotice.classList.remove('hidden');
    metaNotice.textContent = 'WebTorrent client could not be created.';
    return;
  }

  if (activeTorrent) { try { activeTorrent.destroy(); } catch(e) {} activeTorrent = null; }
  clearMetadataTimer();

  activeArea.classList.remove('hidden');
  filesList.innerHTML = '';
  metaNotice.classList.add('hidden');
  torrentNameEl.textContent = 'Adding...';
  torrentStatsEl.textContent = 'Waiting for metadata...';
  progressBar.style.width = '0%';
  peerCountEl.textContent = 'Peers: 0';
  nativeActionRow.classList.remove('hidden');

  metadataTimer = setTimeout(()=> {
    if (activeTorrent && activeTorrent.files && activeTorrent.files.length) return;
    metaNotice.classList.remove('hidden');
    metaNotice.textContent = 'Unable to fetch metadata / connect to peers within 20s. Use "Open in native app" or upload the .torrent file.';
  }, 20000);

  try {
    client.add(magnetOrBuffer, { announce: DEFAULT_WSS_TRACKERS }, (torrent) => {
      activeTorrent = torrent;
      torrentNameEl.textContent = torrent.name || 'Unnamed torrent';
      updateStats();

      // ensure files deselected by default
      try { torrent.files && torrent.files.forEach(f => { if (typeof f.deselect === 'function') try { f.deselect(); } catch(e){} }); } catch(e){}

      if (torrent.files && torrent.files.length) {
        populateFiles(torrent);
        clearMetadataTimer();
      } else {
        torrent.on('metadata', () => { populateFiles(torrent); clearMetadataTimer(); });
      }

      const updater = setInterval(()=> {
        if (!activeTorrent) { clearInterval(updater); return; }
        updateStats();
      }, 700);

      torrent.on('done', ()=> {
        progressBar.style.width = '100%';
        torrentStatsEl.textContent = `Completed • Peers: ${torrent.numPeers || 0}`;
        clearInterval(updater);
      });

      torrent.on('wire', ()=> updateStats());
    });
  } catch (err) {
    console.error('Add torrent error', err);
    metaNotice.classList.remove('hidden');
    metaNotice.textContent = 'Failed to add torrent. Magnet may be invalid or WebRTC blocked.';
    clearMetadataTimer();
  }
}

function clearMetadataTimer() { if (metadataTimer) { clearTimeout(metadataTimer); metadataTimer = null; } }

function populateFiles(torrent) {
  filesList.innerHTML = '';
  if (!torrent.files || !torrent.files.length) {
    filesList.innerHTML = '<div class="text-xs text-slate-400">No files in this torrent.</div>';
    return;
  }

  torrent.files.forEach(file => {
    const row = document.createElement('div');
    row.className = 'flex items-center justify-between gap-3 bg-slate-900/70 p-3 rounded-xl border border-slate-800';
    row.innerHTML = `
      <div class="min-w-0">
        <div class="text-sm font-medium text-slate-100 line-clamp-1">${escapeHtml(file.name)}</div>
        <div class="text-xs text-slate-400 mt-1">${(file.length / (1024*1024)).toFixed(2)} MB</div>
      </div>
      <div class="flex-shrink-0 flex items-center gap-2">
        <button class="btn-download px-3 py-2 rounded-lg bg-accent text-slate-950 text-xs font-semibold">Download</button>
      </div>
    `;
    filesList.appendChild(row);

    const dlBtn = row.querySelector('.btn-download');
    dlBtn.addEventListener('click', () => {
      dlBtn.disabled = true;
      dlBtn.textContent = 'Preparing...';

      // select file (start fetching pieces)
      try { if (typeof file.select === 'function') file.select(); } catch(e) { console.warn('file.select failed', e); }

      file.getBlob((err, blob) => {
        if (err || !blob) {
          console.error('getBlob error', err);
          dlBtn.textContent = 'Failed';
          setTimeout(()=> { dlBtn.disabled=false; dlBtn.textContent='Download'; }, 1400);
          return;
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = file.name;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        dlBtn.textContent = 'Saved';
        setTimeout(()=> { dlBtn.disabled=false; dlBtn.textContent='Download'; }, 1200);
      });
    });
  });
}

function updateStats() {
  if (!activeTorrent) return;
  const t = activeTorrent;
  const percent = Math.round((t.progress || 0) * 10000) / 100;
  progressBar.style.width = `${percent}%`;
  torrentStatsEl.textContent = `${percent}% • ${formatSpeed(t.downloadSpeed || 0)}/s • ${(t.length / (1024*1024)).toFixed(0)} MB total`;
  peerCountEl.textContent = `Peers: ${t.numPeers || 0}`;
}
function formatSpeed(bytesPerSec) {
  if (!bytesPerSec) return '0 KB';
  const units = ['B','KB','MB','GB'];
  let b = bytesPerSec;
  let u = 0;
  while (b >= 1024 && u < units.length-1) { b /= 1024; u++; }
  return `${b.toFixed(2)} ${units[u]}`;
}

/* ============
   UI wiring
   ============ */

addMagnetBtn.addEventListener('click', () => {
  const raw = magnetInput.value.trim();
  if (!raw) { magnetInput.focus(); return; }
  startAddMagnet(raw);
});
magnetInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') addMagnetBtn.click(); });

chooseFileBtn.addEventListener('click', () => torrentFileInput.click());
torrentFileInput.addEventListener('change', (ev) => {
  const f = ev.target.files && ev.target.files[0];
  if (!f) { fileLabel.textContent = 'No file chosen'; return; }
  fileLabel.textContent = f.name;
  const reader = new FileReader();
  reader.onload = function() {
    const arr = new Uint8Array(this.result);
    if (!supportsWebRTC()) nativeActionRow.classList.remove('hidden');
    addTorrent(arr);
  };
  reader.onerror = function() {
    metaNotice.classList.remove('hidden');
    metaNotice.textContent = 'Failed to read .torrent file.';
  };
  reader.readAsArrayBuffer(f);
});

destroyBtn.addEventListener('click', () => {
  if (activeTorrent) try { activeTorrent.destroy(); } catch(e) {}
  activeTorrent = null;
  progressBar.style.width = '0%';
  filesList.innerHTML = '';
  activeArea.classList.add('hidden');
  metaNotice.classList.add('hidden');
  nativeActionRow.classList.add('hidden');
});

/* cleanup */
window.addEventListener('beforeunload', () => {
  if (activeTorrent) try { activeTorrent.destroy(); } catch(e) {}
  if (client) try { client.destroy(); } catch(e) {}
});
</script>
</body>
</html>
